# ğŸš€ Raveninsta - Publish to npm

name: Publish Raveninsta to npm

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ› ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org/'

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ğŸ·ï¸ Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ VersÃ£o atual: $CURRENT_VERSION"

      - name: ğŸ”¢ Calculate next version
        id: next_version
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "ğŸ“¦ Nome do pacote: $PACKAGE_NAME"
          
          # Tenta obter a Ãºltima versÃ£o do npm
          if npm view $PACKAGE_NAME version > /dev/null 2>&1; then
            LATEST_NPM=$(npm view $PACKAGE_NAME version)
            echo "ğŸ“¦ Ãšltima versÃ£o no npm: $LATEST_NPM"
            
            # Incrementa pre-release number
            if [[ "$LATEST_NPM" =~ ^(.*)-([0-9]+)$ ]]; then
              BASE=${BASH_REMATCH[1]}
              NUM=${BASH_REMATCH[2]}
              NEW_NUM=$((NUM + 1))
              NEW_VERSION="$BASE-$NEW_NUM"
            else
              NEW_VERSION="${LATEST_NPM}-1"
            fi
          else
            # Primeira publicaÃ§Ã£o
            NEW_VERSION="${{ steps.current_version.outputs.current_version }}-1"
          fi
          
          echo "ğŸ¯ Nova versÃ£o: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸš€ Update version in package.json
        run: |
          echo "ğŸ”„ Atualizando package.json para: ${{ steps.next_version.outputs.new_version }}"
          npm version "${{ steps.next_version.outputs.new_version }}" --no-git-tag-version --allow-same-version
          echo "âœ… VersÃ£o atualizada"

      - name: ğŸ”§ Fix package.json issues
        run: npm pkg fix

      - name: ğŸ“¤ Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ’¾ Commit and push changes
        run: |
          # Verifica se hÃ¡ mudanÃ§as para commitar
          if git diff --quiet package.json; then
            echo "âš ï¸ Nenhuma mudanÃ§a no package.json para commitar"
          else
            echo "ğŸ’¾ Comitando mudanÃ§as..."
            git add package.json
            git commit -m "ğŸ¤– Raveninsta: version ${{ steps.next_version.outputs.new_version }} [skip ci]"
            git push origin main
            echo "âœ… MudanÃ§as commitadas e enviadas"
          fi

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.next_version.outputs.new_version }}
          name: "ğŸŒ± Raveninsta v${{ steps.next_version.outputs.new_version }}"
          body: |
            ## ğŸš€ Raveninsta Publicado!
            
            **CLI Tool para Instagram - Mapeamento bi-direcional: ID â†” Username**

            ---

            ## ğŸ“¦ InstalaÃ§Ã£o RÃ¡pida

            ```bash
            npm install -g raveninsta
            ```

            ## ğŸ› ï¸ Comandos DisponÃ­veis

            | Comando | DescriÃ§Ã£o | Exemplo |
            |---------|-----------|---------|
            | `raveninsta login` | Autentica no Instagram | `raveninsta login` |
            | `raveninsta buscar <id/username>` | Busca perfil (detecÃ§Ã£o automÃ¡tica) | `raveninsta buscar instagram` |
            | `raveninsta status` | Verifica status da sessÃ£o | `raveninsta status` |
            | `raveninsta sair` | Remove dados de autenticaÃ§Ã£o | `raveninsta sair` |

            ## ğŸ¯ Funcionalidades Principais

            - ğŸ”„ **Mapeamento bidirecional** - Converte ID â‡„ Username automaticamente
            - ğŸ” **DetecÃ§Ã£o inteligente** - Reconhece automaticamente o tipo de entrada
            - ğŸ“Š **Dados pÃºblicos** - Coleta informaÃ§Ãµes bÃ¡sicas do perfil
            - ğŸ–¼ï¸ **Screenshot opcional** - Captura da pÃ¡gina do perfil
            - ğŸ“ **RelatÃ³rios organizados** - Exporta em TXT e JSON
            - ğŸ”’ **SessÃ£o segura** - Criptografia AES-256 para dados de login
            - ğŸ”„ **HistÃ³rico de mudanÃ§as** - Rastreia alteraÃ§Ãµes de username

            ## ğŸ”‘ ConfiguraÃ§Ã£o Inicial

            ### Primeiro Uso - Login NecessÃ¡rio

            ```bash
            raveninsta login
            ```

            ğŸ“ **Processo de login:**
            1. O navegador serÃ¡ aberto automaticamente na pÃ¡gina de login do Instagram
            2. **FaÃ§a o login manualmente** no navegador que abriu
            3. Aguarde o redirecionamento para o feed principal
            4. O navegador fecharÃ¡ automaticamente apÃ³s o login ser detectado
            5. Sua sessÃ£o serÃ¡ salva com criptografia AES-256

            ğŸ’¡ **Dica:** Use uma conta alternativa do Instagram dedicada para a ferramenta

            ### ğŸ”’ Arquivos de SessÃ£o

            ApÃ³s o login, sÃ£o gerados:
            - **session_data.json** - Cookies e dados de sessÃ£o criptografados
            - **session_key.bin** - Chave de criptografia AES-256

            **â„¹ï¸ Importante:** Esses arquivos contÃªm tokens de acesso Ã  sua conta. Mantenha-os seguros e nÃ£o compartilhe com ninguÃ©m.

            ## ğŸš€ Como Usar

            ```bash
            # Busca por username ou ID (detecÃ§Ã£o automÃ¡tica)
            raveninsta buscar usuario123
            raveninsta buscar 123456789

            # OpÃ§Ãµes adicionais
            raveninsta buscar usuario123 --no-screenshot
            raveninsta buscar usuario123 -o ./investigacoes

            # Gerenciamento de sessÃ£o
            raveninsta status
            raveninsta sair
            ```

            ## ğŸ”— Links

            - **[ğŸ“¦ npm Package](https://www.npmjs.com/package/raveninsta)**
            
            ---

            ### ğŸ“‹ Dados Coletados (Apenas PÃºblicos)

            - âœ… ID do perfil
            - âœ… Username atual e histÃ³rico
            - âœ… Nome completo
            - âœ… Biografia
            - âœ… Contagem de seguidores/seguindo
            - âœ… NÃºmero de posts
            - âœ… Status de verificaÃ§Ã£o
            - âœ… Status de privacidade

            ### ğŸš« O que NÃƒO Ã© coletado

            - âŒ Mensagens privadas
            - âŒ Dados de seguidores individuais
            - âŒ InformaÃ§Ãµes restritas
            - âŒ ConteÃºdo de perfis privados

            ---

            **ğŸ“… VersÃ£o:** ${{ steps.next_version.outputs.new_version }}  
            **ğŸ”– Tag:** v${{ steps.next_version.outputs.new_version }}  
            **âš¡ Publicado automaticamente via GitHub Actions**

            > âš ï¸ **Aviso:** Esta ferramenta Ã© para fins educacionais e de pesquisa.  
            > Respeite os termos de serviÃ§o do Instagram e use com responsabilidade.
          draft: false
          prerelease: true